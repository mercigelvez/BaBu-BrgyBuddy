{% extends 'layouts/base.html' %}

{% block title %}
  Appointments
{% endblock %}

{% block content %}
  <div class="min-height-300 bg-gradient-success position-absolute w-100"></div>

  {% include 'includes/admin_sidenav.html' %}

  <main class="main-content position-relative border-radius-lg">
    {% include 'includes/navigation.html' %}

    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h6>Document Request Appointments</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div id="calendar"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h6>Appointment Details</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Name</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Address</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Birthday</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Birthplace</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Purpose</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Appointment Date</th>
                    </tr>
                  </thead>
                  <tbody id="appointmentTableBody">
                    <!-- Table rows will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
{% endblock %}

{% block javascripts %}
  {{ super() }}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js"></script>
  <script>
    var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      if (!calendarEl) {
        console.error('Calendar element not found');
        return;
      }

      fetch($SCRIPT_ROOT + '/get_appointments')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log('Appointment data:', data);

          window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: data,
            eventClick: function(info) {
              const row = document.getElementById('appointment-' + info.event.id);
              if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                row.classList.add('highlight');
                setTimeout(() => row.classList.remove('highlight'), 2000);
              }
            }
          });
          window.calendar.render();

          const tableBody = document.getElementById('appointmentTableBody');
          data.forEach(apt => {
            const row = document.createElement('tr');
            row.id = 'appointment-' + apt.id;
            row.innerHTML = `
              <td>${apt.title.split(' - ')[0]}</td>
              <td>${apt.address || ''}</td>
              <td class="text-center">${apt.birthday || ''}</td>
              <td class="text-center">${apt.birthplace || ''}</td>
              <td class="text-center">${apt.title.split(' - ')[1]}</td>
              <td class="text-center">${new Date(apt.start).toLocaleString()}</td>
            `;
            tableBody.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error:', error);
          calendarEl.textContent = 'Failed to load appointments';
        });
    });
  </script>
{% endblock %}